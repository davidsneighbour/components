{{/* create collection */}}
{{ $collection := slice }}

{{/* load plugged in templated scripts from modules */}}
{{ range $key, $value := $.Site.Data.dnb }}
  {{- partial "func/debug" (dict "message" (printf "Checking SCSSTemplate configuration %s" $key) "severity" "debug") -}}
  {{ if (and (isset $value "config") (isset $value.config "plugins") (isset $value.config.plugins "scssTemplates")) }}
    {{ range $value.config.plugins.scssTemplates }}
      {{- partial "func/debug" (dict "message" (printf "Loading SCSSTemplate %s" .) "severity" "debug") -}}
      {{ $template := . }}
      {{ $scss := resources.Get $template | resources.ExecuteAsTemplate (print now.Unix $template) . }}
      {{ $collection = $collection | append ($scss) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* load plugged in scripts from modules */}}
{{ range $key, $value := $.Site.Data.dnb }}
  {{- partial "func/debug" (dict "message" (printf "Checking SCSS configuration %s" $key) "severity" "debug") -}}
  {{ if (and (isset $value "config") (isset $value.config "plugins") (isset $value.config.plugins "scss")) }}
    {{ range $value.config.plugins.scss }}
      {{- partial "func/debug" (dict "message" (printf "Loading SCSSFile %s" .) "severity" "debug") -}}
      {{ $collection = $collection | append (resources.Get .) }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $collection = $collection | append (resources.Get "scss/theme.scss") | resources.Concat "stylesheet.scss" }}

{{ partial "debugprint" $collection }}

{{ $config := site.Data.dnb.functions.system.config }}

{{ $options := (dict "targetPath" "style.css" "outputStyle" "compressed" "enableSourceMap" true "precision" 6 "includePaths" (slice "node_modules")) }}
{{ $style := $collection | resources.ToCSS $options | resources.PostCSS (dict "config" "postcss.config.js") | resources.Minify |  resources.Fingerprint "sha512" }}
{{ with $config.postprocess }}
  {{- partial "func/debug" (dict "message" "going into PostProcessing" "context" . "severity" "info") -}}
  {{ $style = $style | resources.PostProcess }}
{{ end }}
{{ return $style }}
